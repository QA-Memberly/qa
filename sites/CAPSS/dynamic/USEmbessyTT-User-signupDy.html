<html>
    <head>
       <meta charset="utf-8">
       <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
       <meta name="description" content="">
       <meta name="generator" content="Jekyll v4.1.1">
       <title>User</title>
       <link href="../assets/dist/css/selectize/normalize.css" rel="stylesheet">
       <link href="../assets/dist/css/selectize/selectize.default.css" rel="stylesheet">
       <link href="../assets/dist/css/custom-formio/theme.less.css" rel="stylesheet">
	   <link href="../assets/dist/css/main.css" rel="stylesheet">
       <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css'>
       <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css'>
       <link href="../assets/dist/css/custom-formio/formio.full.min.css" rel="stylesheet">
       <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.core.min.js" integrity="sha512-w66UYDpfZgAuo4abswC7aUEQ1zdJc8/EwjlwlcOcrK6V6PLcnhWb+hKukf69JyeZ2lwMjeaCPBMpl4ep15d9nA==" crossorigin="anonymous"></script>
       <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js" integrity="sha512-90vH1Z83AJY9DmlWa8WkjkV79yfS2n2Oxhsi2dZbIv0nC4E6m5AbH8Nh156kkM7JePmqD6tcZsfad1ueoaovww==" crossorigin="anonymous"></script>
       <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
       <script src="https://cdn.rawgit.com/meetselva/attrchange/master/js/attrchange.js"></script>
       <script src='../assets/dist/js/investigate/selectize.js'></script>
	   <script src='../assets/dist/js/main.js'></script>
       <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
       <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
       <script src='https://unpkg.com/formiojs@latest/dist/formio.full.min.js'></script>
       
       <script>
		var globalForm = null;
		
		$(document).ready(function () {
			
			var docvars = getUrlVars();
			
			var formDefinitionDept = "US-Embassy-Usersignup";
			var formObj = null;
			var isUser = true;
			var userUrl = "https://qa.servicedx.com/admin/departments/formio/"+docvars.departmentName+"/users/"+docvars.userName;
			//var userUrl = "http://localhost:9100/admin/departments/formio/"+docvars.departmentName+"/users/"+docvars.userName;
			
			if (docvars.page.toLowerCase() == "edituser"){
				formObj = getFormObj(userUrl);
			  if(formObj.data.hasOwnProperty('errorCode') && formObj.data.errorCode == "SDX_ADMIN_100" || formObj.data.errorCode =="SDX_ADMIN_EXCEPTION"){
				isUser = false;
				formObj = null
			  }
			}else {
				isUser = false;
			}
			
			var formDefinition = getFormComp("https://qa.servicedx.com/admin/departments/" + formDefinitionDept, "user");
			
			Formio.createForm(document.getElementById('builder'), formDefinition)
				.then(function (form) {
					console.log(formObj,isUser);
					var userObj;
					if(formObj != null){
						userObj = editObject(formObj);
					}else{
						userObj = {};
					}
					userObj["page"] = docvars.page;
					form.submission = { data: userObj };
					
					console.log(userObj);
					globalForm = form;
					//form.setPristine(false);
					form.nosubmit = true;
					form.on('submit', function (submission) {
						$('#formSubmit').attr('disabled','disabled');
						var userObject = submission.data;
						console.log("B4 : userObject : " + JSON.stringify(userObject));

						delete userObject["submit"];
						delete userObject["confirmPassword"];
						delete userObject["hobbies"];
						delete userObject["sameAsPresentAddress"];
						delete userObject["phoneCountryCode"];
						delete userObject["phoneCountryCode2"];
						delete userObject["phoneNo"];
						delete userObject["secondPhoneNo"];
						delete userObject["countrys"];
						delete userObject["secondaryCountrys"];
						delete userObject["page"];
						delete userObject["anniversaryDate1"];
						delete userObject["birthDate1"];
						delete userObject["addressProofPic1"];
						delete userObject["specialSkills"];
						delete userObject["maritalStatus1"];
						delete userObject["others"];
						
						userObject["departmentName"] = docvars.departmentName;
						userObject["source"] = "MOBILE";
						userObject["active"] = true;
						console.log("AF : " + JSON.stringify(userObject))
						
						if(!isUser){
							fetchAPI("https://qa.servicedx.com/admin/departments/formio/" + docvars.departmentName + "/users", options(JSON.stringify(userObject), isUser)).then(response => {
								if(!response.hasOwnProperty('errorCode')){
									form.emit('submitDone', 'Create Success')
								}else{
									form.emit('submitError', response.message);
								}
							}).catch(function(error) {
								console.log("error fetch",error);
							});
						}else{
							fetchAPI("https://qa.servicedx.com/admin/departments/formio/" + docvars.departmentName + "/users/" + docvars.userName, options(JSON.stringify(userObject), isUser)).then(response => {
								if(!response.hasOwnProperty('errorCode')){
									form.emit('submitDone', 'Update Success')
								}else{
									form.emit('submitError', response.message)
								}
							}).catch(function(error) {
								console.log("error fetch",error);
							});
						}
					});
					
					selectize(globalForm);

				});
		});

		
		function editObject(obj){
				var json = JSON.parse(obj.data);
				console.log(json);
				var id1 = json.mobileNo;
				var id2 = json.secondMobileNo;
					
				if (id1 && id1.length > 10) {
					json["phoneNo"] = id1.substr(id1.length - 10);
				}
				if (id2 && id2.length > 10) {
					json["secondPhoneNo"] = id2.substr(id2.length - 10);
				}
				
				if(json.addressProofPic != null){
						json["addressProofPic1"] = JSON.parse(json.addressProofPic);
					}else{
						json["addressProofPic1"] = [];
					}
				 
				var otherInterests = {};
				for (i = 0; i < json.otherInterests.length; i++) {
				  otherInterests[json.otherInterests[i]] = true; 
				}
				json["specialSkills"] = otherInterests;
				json["birthDate1"] = json.birthDate;
				json["anniversaryDate1"] = json.anniversaryDate;
				
				if(json.maritalStatus != "married" && json.maritalStatus != "unmarried" && json.maritalStatus != "divorced" ){
					json["maritalStatus1"] = "others";
					json["others"] = json.maritalStatus;
				}else{
					json["maritalStatus1"] = json.maritalStatus;
				}
				
				json["phoneCountryCode"] = json.countryCodeValue;
				json["phoneCountryCode2"] = json.secondaryCountryCodeValue;
				json["countrys"] = {
					"countryCode": json.countryCode,
					"countryName": json.countryName.charAt(0).toUpperCase() + json.countryName.slice(1),
					"countryCodeValue": json.countryCodeValue
				};
				json["secondaryCountrys"] = {
					"countryCode": json.countryCode,
					"countryName": json.countryName.charAt(0).toUpperCase() + json.countryName.slice(1),
					"countryCodeValue": json.countryCodeValue
				};
			return json;
		}
       </script>
       <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600" rel="stylesheet">
    </head>
    <body style="padding:10px;background-color: #dde0e0;">
       <div id="wrapper">
          <div id="loader" class="hidden">
             <div id="loaderCircle"></div>
          </div>
          <div id="initScreen" style="display: block;">
             <div class="section" id="a67a329f1c344dfd887b3efc8a413ed3">
                <div class="screen" id="survey-screen-1" style="background-color: rgb(245, 249, 250);">
                   <div class="main-container">
                      <div id="survey-section" class="">
                         <div class="survey-sub-screen multiplechoice-question-component" id="survey-sub-screen-half-n-half">
                            <div class="head">
                            </div>
                            <div class="question-answer-row" id="section" style="padding-left:10px;padding-right:10px;">
                               <div class="question-answer-cell">
                                  <div id='builder'></div>
                               </div>
                            </div>
                         </div>
                      </div>
                      <div class="footer-row">
                         <div class="footer hide-submit">
                            <div id="logo-container">
                               <img style="width:50px;height:40px;" id="logo" src="https://static.wixstatic.com/media/eaa914_9cf3646c1306425db2dc5191490521f2~mv2.png/v1/crop/x_0,y_21,w_340,h_274/fill/w_121,h_96,al_c,q_85,usm_0.66_1.00_0.01/logo_edited.webp" alt="Logo" class="">
                            </div>
                         </div>
                      </div>
                   </div>
                </div>
             </div>
          </div>
          <div id="main-error-container" class="hidden">
             <div id="error-message">Something went wrong. Please retry.</div>
             <div id="retry-button">Retry</div>
          </div>
       </div>
    </body>
 </html>